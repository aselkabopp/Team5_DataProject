create or replace view "TARGITO_207F62E1-FC2D-4D55-9C5C-B800034DCC62".ANALYSIS.CUSTOMERS(
	ID,
	GENDER_NEW,
	CREATED_SOURCE,
	CREATED_DATE,
	UPDATED_DATE,
	ORIGIN,
	IS_OPTED_IN,
	IS_OPTED_OUT,
	OPTOUT_DATE,
	OPTOUT_REQUEST_INFO,
	EMAIL_STO_MOST_ACTIVE,
	EMAIL_STO_LAST_OPEN,
	LAST_UPDATE,
	STATUS,
	ACTIVE,
	NAMEDAY,
	SOURCE_FORMATTED,
	SOURCE,
	FAVORITE_CATEGORIES,
	_AVG_OR_90,
	_AVG_CR_90,
	_RFM_R,
	_RFM_F,
	_RFM_M,
	_RFM_SCORE,
	_ID_NEAREST_BRANCH,
	KAMAN_FB_LEADS,
	CPC,
	NUMBER_OF_ORDERS
) as (
select 
    c.ID, 
    CASE
    WHEN c.GENDER = 'female' and c.GENDER_TARGITO is null
       THEN 'F'
    WHEN c.GENDER = 'male' and c.GENDER_TARGITO is null
       THEN 'M'
    WHEN c.GENDER is null and c.GENDER_TARGITO is null
       THEN 'unknown'
    ELSE c.GENDER_TARGITO
    END AS GENDER_NEW,
    c.CREATED_SOURCE, 
    c.CREATED_DATE, 
    c.UPDATED_DATE, 
    c.ORIGIN,
    c.IS_OPTED_IN, 
    c.IS_OPTED_OUT, 
    c.OPTOUT_DATE, 
    c.OPTOUT_REQUEST_INFO, 
    c.EMAIL_STO_MOST_ACTIVE, 
    c.EMAIL_STO_LAST_OPEN, 
    c.LAST_UPDATE, 
    c.STATUS, 
    c.ACTIVE, 
    c.NAMEDAY, 
     CASE 
        WHEN Source is null THEN 'unknown' 
        ELSE Source 
    END AS SOURCE_FORMATTED,
    c.SOURCE, 
    c.FAVORITE_CATEGORIES, 
    c._AVG_OR_90, 
    c._AVG_CR_90, 
    c._RFM_R, 
    c._RFM_F,
    c._RFM_M, 
    c._RFM_SCORE, 
    c._ID_NEAREST_BRANCH, 
    c.KAMAN_FB_LEADS, 
    c.CPC, 
    count(o.order_id) as number_of_orders
from "TARGITO_207F62E1-FC2D-4D55-9C5C-B800034DCC62".PUBLIC.CONTACTS as c
inner join "TARGITO_207F62E1-FC2D-4D55-9C5C-B800034DCC62".PUBLIC.ORDERS as o
on c.id = o.contact_id
GROUP BY c.ID, c.CREATED_SOURCE, c.CREATED_DATE, c.UPDATED_DATE, c.ORIGIN, c.IS_OPTED_IN, c.IS_OPTED_OUT, c.OPTOUT_DATE, c.OPTOUT_REQUEST_INFO, c.EMAIL_STO_MOST_ACTIVE, c.EMAIL_STO_LAST_OPEN, c.LAST_UPDATE, c.GENDER, c.STATUS, c.ACTIVE, c.GENDER_TARGITO, c.NAMEDAY, c.SOURCE, c.FAVORITE_CATEGORIES, c._AVG_OR_90, c._AVG_CR_90, c._RFM_R, c._RFM_F, c._RFM_M, c._RFM_SCORE, c._ID_NEAREST_BRANCH, c.KAMAN_FB_LEADS, c.CPC 
)
;
